<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ê–Ω–∞–ª–∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π</title>
  <style>
    body { font-family: Arial; background: #fafafa; padding: 30px; color: #333; }
    button { padding: 10px 20px; background: #007BFF; color: white; border: none; border-radius: 6px; cursor: pointer; }
    button:disabled { background: #999; cursor: not-allowed; }
    .progress-container { margin-top: 30px; width: 100%; background: #ddd; border-radius: 10px; height: 24px; overflow: hidden; }
    .progress-bar { height: 100%; width: 0%; background: #28a745; transition: width 0.5s; }
    .limits { margin-top: 20px; font-size: 14px; }
    .warning { color: #e67e22; }
    .danger { color: #c0392b; }
  </style>
</head>
<body>
  <h2>üì∑ –ê–Ω–∞–ª–∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π</h2>
  <button id="startBtn">üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –∞–Ω–∞–ª–∏–∑</button>

  <div class="progress-container">
    <div class="progress-bar" id="progressBar"></div>
  </div>
  <p id="progressText">–û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞...</p>

  <div class="limits">
    <h3>‚öôÔ∏è –õ–∏–º–∏—Ç—ã –º–æ–¥–µ–ª–∏:</h3>
    <p>–ú–æ–¥–µ–ª—å: <b id="modelName">‚Äì</b></p>
    <p>–û—Å—Ç–∞–≤—à–∏–µ—Å—è –∑–∞–ø—Ä–æ—Å—ã: <b id="remainingRequests">‚Äì</b></p>
    <p>–û—Å—Ç–∞–≤—à–∏–µ—Å—è —Ç–æ–∫–µ–Ω—ã: <b id="remainingTokens">‚Äì</b></p>
    <p>–°–±—Ä–æ—Å –ª–∏–º–∏—Ç–∞: <b id="resetTime">‚Äì</b></p>
  </div>

  <script>
    const startBtn = document.getElementById('startBtn');
    const bar = document.getElementById('progressBar');
    const text = document.getElementById('progressText');

    startBtn.onclick = async () => {
      startBtn.disabled = true;
      text.textContent = '‚è≥ –ê–Ω–∞–ª–∏–∑ –∑–∞–ø—É—â–µ–Ω...';
      await fetch('/analyze', { method: 'POST' });
      updateProgress();
      updateLimits();
    };

    async function updateProgress() {
      const res = await fetch('/progress');
      const data = await res.json();

      if (data.total > 0) {
        const percent = (data.processed / data.total) * 100;
        bar.style.width = percent + '%';
        text.textContent = `üì¶ –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ ${data.processed} –∏–∑ ${data.total}`;
      }

      if (data.status === 'done') {
        text.textContent = '‚úÖ –ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω!';
        startBtn.disabled = false;
        return;
      }

      setTimeout(updateProgress, 2000);
    }

    async function updateLimits() {
      const res = await fetch('/limits');
      const data = await res.json();

      document.getElementById('modelName').textContent = data.model;
      document.getElementById('remainingRequests').textContent = data.remaining_requests || '‚Äì';
      document.getElementById('remainingTokens').textContent = data.remaining_tokens || '‚Äì';
      document.getElementById('resetTime').textContent = data.limit_reset || '‚Äì';

      setTimeout(updateLimits, 10000);
    }
  </script>
</body>
</html>
