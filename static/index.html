<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>AI –ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
  <style>
    body { background: #f8f8f8; }
    #progress-container { margin-top: 20px; }
    #log { background: #fff; padding: 10px; height: 200px; overflow-y: auto; border: 1px solid #ddd; }
    #limitInfo { font-weight: bold; }
  </style>
</head>
<body class="section">
  <div class="container">
    <h1 class="title">üîß AI –ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä –¥–µ—Ç–∞–ª–µ–π</h1>

    <div class="buttons">
      <button id="startBtn" class="button is-primary">üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –∞–Ω–∞–ª–∏–∑</button>
      <button id="stopBtn" class="button is-danger" disabled>‚õî –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
    </div>

    <p>üí∞ –õ–∏–º–∏—Ç—ã OpenAI: <span id="limitInfo">–∑–∞–≥—Ä—É–∑–∫–∞...</span></p>

    <div id="progress-container">
      <progress id="progress" class="progress is-info" value="0" max="100">0%</progress>
    </div>

    <h2 class="subtitle mt-4">–õ–æ–≥–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</h2>
    <div id="log"></div>
  </div>

  <script>
    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");
    const progressBar = document.getElementById("progress");
    const logDiv = document.getElementById("log");
    const limitInfo = document.getElementById("limitInfo");
    let stopRequested = false;

    function log(message, color="#333") {
      const line = document.createElement("div");
      line.style.color = color;
      line.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      logDiv.appendChild(line);
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    async function fetchModelLimits() {
      try {
        const res = await fetch("/model_limits");
        const data = await res.json();
        if (data.status === "ok") {
          const text = `${data.remaining} / ${data.total_granted} USD (–æ–±–Ω–æ–≤–ª–µ–Ω–æ ${data.updated})`;
          limitInfo.textContent = text;
          limitInfo.style.color = data.remaining < 1 ? "red" : "#222";
        } else limitInfo.textContent = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–∏–º–∏—Ç–æ–≤";
      } catch {
        limitInfo.textContent = "–û—à–∏–±–∫–∞ —Å–µ—Ç–∏";
      }
    }
    setInterval(fetchModelLimits, 10000);
    fetchModelLimits();

    async function startAnalysis() {
      stopRequested = false;
      startBtn.disabled = true;
      stopBtn.disabled = false;
      progressBar.value = 0;
      log("–ó–∞–ø—É—Å–∫ –∞–Ω–∞–ª–∏–∑–∞...", "blue");

      const res = await fetch("/analyze", { method: "POST" });
      const data = await res.json();

      if (data.status === "done") {
        log(`‚úÖ –ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à—ë–Ω. –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ ${data.processed_count} —Ñ–∞–π–ª–æ–≤.`, "green");
        progressBar.value = 100;
      } else {
        log(`‚ö†Ô∏è –û—à–∏–±–∫–∞: ${data.message}`, "red");
      }

      startBtn.disabled = false;
      stopBtn.disabled = true;
    }

    startBtn.onclick = startAnalysis;
    stopBtn.onclick = () => {
      stopRequested = true;
      log("–û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º", "orange");
      startBtn.disabled = false;
      stopBtn.disabled = true;
    };
  </script>
</body>
</html>
