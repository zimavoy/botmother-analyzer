<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Live –ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä (Yandex Vision)</title>
  <style>
    body { font-family: Inter, system-ui, Arial; background:#f6f8fa; margin:0; padding:18px; color:#111; }
    .card { max-width:980px; margin:14px auto; background:#fff; padding:18px; border-radius:12px; box-shadow:0 6px 20px rgba(22,28,37,0.06); }
    .controls { display:flex; gap:10px; flex-wrap:wrap; }
    button { padding:10px 14px; border-radius:8px; border:0; cursor:pointer; background:#2563eb; color:#fff; }
    button.stop { background:#ef4444; }
    #progressWrap { margin-top:12px; background:#e6eef8; border-radius:12px; height:22px; overflow:hidden; }
    #prog { height:22px; width:0%; background:linear-gradient(90deg,#06b6d4,#34d399); transition:width .4s; }
    .statusRow { display:flex; gap:12px; margin-top:12px; align-items:center; }
    .stat { background:#f1f5f9; padding:8px 12px; border-radius:8px; font-size:14px; }
    #log { margin-top:14px; background:#0f172a; color:#e2e8f0; padding:12px; border-radius:8px; height:300px; overflow:auto; font-family:monospace; font-size:13px; white-space:pre-wrap; }
  </style>
</head>
<body>
  <div class="card">
    <h2>üîç Live –ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π ‚Äî Yandex Vision</h2>

    <div class="controls" style="margin-top:12px;">
      <button id="startBtn">üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –∞–Ω–∞–ª–∏–∑</button>
      <button id="stopBtn" class="stop">‚õî –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
      <div style="margin-left:auto; display:flex; gap:8px; align-items:center;">
        <div class="stat">API key: <span id="apiStatus">‚Äî</span></div>
        <div class="stat">Model/Limits: <span id="limitStatus">‚Äî</span></div>
      </div>
    </div>

    <div id="progressWrap">
      <div id="prog">0%</div>
    </div>

    <div class="statusRow">
      <div class="stat">–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ: <span id="processed">0</span></div>
      <div class="stat">–í—Å–µ–≥–æ: <span id="total">0</span></div>
      <div class="stat">UNKNOWN: <span id="unknown">0</span></div>
      <div class="stat">Concurrency: <span id="concurrency">?</span></div>
    </div>

    <div id="log">–õ–æ–≥ —Å–æ–±—ã—Ç–∏–π –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å...</div>
  </div>

<script>
(function(){
  const startBtn = document.getElementById('startBtn');
  const stopBtn  = document.getElementById('stopBtn');
  const prog     = document.getElementById('prog');
  const processedEl = document.getElementById('processed');
  const totalEl = document.getElementById('total');
  const unknownEl = document.getElementById('unknown');
  const apiStatus = document.getElementById('apiStatus');
  const limitStatus = document.getElementById('limitStatus');
  const logEl = document.getElementById('log');

  let total = 0, processed = 0, unknown = 0;
  const concurrency = { value: null };
  document.getElementById('concurrency').textContent = (new URLSearchParams(location.search).get('concurrency')) || 'configured';

  function appendLog(line){
    const t = new Date().toLocaleTimeString();
    logEl.textContent += `[${t}] ${line}\n`;
    logEl.scrollTop = logEl.scrollHeight;
  }

  // SSE
  const evtSource = new EventSource('/stream');
  evtSource.addEventListener('log', e => {
    appendLog(e.data);
  });
  evtSource.addEventListener('start', e => {
    const d = JSON.parse(e.data);
    total = d.total || 0;
    totalEl.textContent = total;
    processed = 0;
    processedEl.textContent = processed;
    unknown = 0;
    unknownEl.textContent = unknown;
    prog.style.width = '0%';
  });
  evtSource.addEventListener('progress', e => {
    const d = JSON.parse(e.data);
    processed = d.processed || processed;
    processedEl.textContent = processed;
    const pct = total>0 ? Math.round((processed/total)*100) : 0;
    prog.style.width = pct + '%';
    prog.textContent = pct + '%';
  });
  evtSource.addEventListener('result', e => {
    const d = JSON.parse(e.data);
    const preview = d.text_preview || d.text || '';
    appendLog(`‚úÖ ${d.file} ‚Üí ${preview.slice(0,180)}`);
    if(preview === 'UNKNOWN') {
      unknown++;
      unknownEl.textContent = unknown;
    }
  });
  evtSource.addEventListener('done', e => {
    const d = JSON.parse(e.data);
    appendLog(`üéâ Done. Processed: ${d.processed}`);
    // ping limits after done
    fetch('/limits').then(r=>r.json()).then(j=>{
      apiStatus.textContent = j.api_key_present ? 'present' : 'missing';
      if(j.checked){
        limitStatus.textContent = j.ok ? `OK (code ${j.status_code})` : `ERROR (${j.status_code})`;
      } else {
        limitStatus.textContent = j.note || 'n/a';
      }
    }).catch(_=>{});
  });
  evtSource.addEventListener('error', e => {
    appendLog(`‚ùå error: ${e.data || '(connection error)'}`);
  });

  // endpoints
  startBtn.onclick = async () => {
    appendLog('‚ñ∂ Requesting start...');
    const r = await fetch('/start', { method: 'POST' });
    if(r.status === 200 || r.status === 201){
      appendLog('Worker started');
    } else if(r.status === 409){
      appendLog('Worker already running');
    } else {
      const j = await r.json().catch(()=>({}));
      appendLog('Start failed: ' + (j.message || r.statusText));
    }
    // refresh limits
    fetch('/limits').then(r=>r.json()).then(j=>{
      apiStatus.textContent = j.api_key_present ? 'present' : 'missing';
      limitStatus.textContent = j.note || (j.checked ? (j.ok ? 'OK' : 'ERROR') : 'n/a');
    }).catch(_=>{});
  };

  stopBtn.onclick = async () => {
    appendLog('‚è∏ Requesting stop...');
    const r = await fetch('/stop', { method: 'POST' });
    if(r.ok) appendLog('Stop requested');
    else appendLog('Stop request failed');
  };

  // initial limits check
  fetch('/limits').then(r=>r.json()).then(j=>{
    apiStatus.textContent = j.api_key_present ? 'present' : 'missing';
    limitStatus.textContent = j.note || (j.checked ? (j.ok ? 'OK' : 'ERROR') : 'n/a');
  }).catch(_=>{});
})();
</script>
</body>
</html>
