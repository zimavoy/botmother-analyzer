<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Анализ деталей</title>
<style>
  body { font-family: Arial; margin: 20px; }
  #progress-bar { width: 100%; background-color: #eee; height: 20px; border-radius: 5px; overflow: hidden; margin-bottom: 10px; }
  #progress { height: 100%; width: 0%; background-color: #4caf50; }
  pre { background: #f4f4f4; padding: 10px; max-height: 200px; overflow-y: auto; margin-bottom: 10px; }
</style>
</head>
<body>
<h1>Анализ деталей</h1>
<button onclick="startAnalysis()">Запустить анализ</button>
<p>Текущая модель: <span id="current-model">-</span></p>
<p>Оставшийся лимит токенов: <span id="remaining-tokens">-</span></p>
<div id="progress-bar"><div id="progress"></div></div>

<h2>Лог основного анализа</h2>
<pre id="log-main"></pre>

<h2>Лог повторного анализа (UNKNOWN)</h2>
<pre id="log-retry"></pre>

<script>
let interval;

function startAnalysis() {
    fetch("/start", {method: "POST"})
    .then(res => res.json())
    .then(data => {
        if(data.status === "started") {
            interval = setInterval(updateProgress, 1000);
        }
    });
}

function updateProgress() {
    fetch("/progress")
    .then(res => res.json())
    .then(data => {
        document.getElementById("current-model").innerText = data.current_model;
        document.getElementById("remaining-tokens").innerText = data.remaining_tokens || "-";
        document.getElementById("log-main").innerText = data.main_log.join("\n");
        document.getElementById("log-retry").innerText = data.retry_log.join("\n");
        document.getElementById("progress").style.width = data.percent + "%";

        if(data.done) clearInterval(interval);
    });
}
</script>
</body>
</html>
